<!DOCTYPE html>
<html lang = "en" layout:decorate = "~{layout}" xmlns:layout = "http://www.ultraq.net.nz/thymeleaf/layout">
    <head>
        <title>[[${movie.title}]]</title>
        <link rel = "stylesheet" th:href = "@{/css/details.css}">
    </head>
    <body>
        <section layout:fragment = "content">
            <div class = "modal" id = "customAlert">
                <div class = "modal-content">
                    <p style = "margin: 0; font-size: 1.2rem">
                        <strong>[[${errorReport}]]</strong>
                        <span class = "close"></span>
                    </p>
                </div>
            </div>
            <div class = "container mt-5">
                <div class = "movie-details row">
                    <div class = "text-center col-md-4">
                        <img alt = "Movie Poster" class = "img-fluid movie-poster rounded" decoding = "async" fetchpriority = "high" height = "360px" th:src = "${'https://wsrv.nl/?url=' + movie.posterUrl + '&output=webp'}" width = "360px">
                        <div class = "d-flex justify-content-center mt-3" style = margin-bottom:20px>
                            <form action = "/booking" class = "mr-2">
                                <input name = "title" th:value = "${movie.title}" type = "hidden">
                                <button class = "btn btn-primary" style = margin-right:20px th:if = "${movie.nowShowing == true}" type = "submit">Chọn ghế</button>
                            </form>
                            <a class = "btn btn-secondary" id = "showTrailerBtn" target = "_blank" th:href = "@{${movie.trailerUrl}}" th:if = "${!movie.trailerUrl.isEmpty()}">Xem trailer</a>
                            <div class = "btn btn-secondary" th:if = "${movie.trailerUrl.isEmpty()}">Xem trailer<span th:if = "${movie.trailerUrl.isEmpty()}"> (Đang cập nhật)</span>
                            </div>
                        </div>
                    </div>
                    <div class = "col-md-8"><h1 class = "h2"><strong>[[${movie.title}]]</strong></h1>
                        <h2 class = "h4">
                            <strong>Ngày khởi chiếu: </strong>[[${movie.releaseDate}]]<span th:if = "${movie.releaseDate.isEmpty()}"> (Đang cập nhật)</span>
                        </h2>
                        <div class = "movie-details">
                            <p class = "h5" id = "description" onclick = toggleDescription()>
                                <strong>Nội dung: </strong>[[${movie.description}]]
                                <span th:if = "${movie.description.isEmpty()}">(Đang cập nhật)</span></p>
                            <button id = "show-more-btn" onclick = toggleDescription()>Xem thêm</button>
                        </div>
                        <hr class = "my-4">
                        <h4 class = "h5">
                            <strong>Diễn viên: </strong>[[${movie.actors}]]<span th:if = "${movie.actors.isEmpty()}">(Đang cập nhật)</span>
                        </h4><h4 class = "h5">
                            <strong>Đạo diễn: </strong>[[${movie.director}]]<span th:if = "${movie.director.isEmpty()}"> (Đang cập nhật)</span>
                        </h4><h4 class = "h5">
                            <strong>Thể loại: </strong>[[${movie.genre}]]<span th:if = "${movie.genre.isEmpty()}">(Đang cập nhật)</span>
                        </h4><h4 class = "h5">
                            <strong>Ngôn ngữ: </strong>[[${movie.language}]]<span th:if = "${movie.language.isEmpty()}"> (Đang cập nhật)</span>
                        </h4><h4 class = "h5">
                            <strong>Phân loại: </strong>[[${movie.rated}]]<span th:if = "${movie.rated.isEmpty()}">(Đang cập nhật)</span>
                        </h4><h4 class = "h5">
                            <strong>Thời lượng: </strong>[[${movie.duration}]] phút<span th:if = "${movie.duration == 0}"> (Đang cập nhật)</span>
                        </h4></div>
                </div>
            </div>
            <br>
            <div sec:authorize = "!isAuthenticated()">
                <div class = "login-notification">Vui lòng đăng nhập để có thể bình luận.</div>
            </div>
            <div class = "comment-form" sec:authorize = "isAuthenticated()">
                <form method = "post" th:action = "@{/details}">
                    <div><input name = "title" th:value = "${movie.title}" type = "hidden"></div>
                    <div><label for = "content">Viết bình luận của bạn:</label></div>
                    <div>
                        <textarea id = "content" name = "content" placeholder = "Nhập bình luận của bạn ở đây..." required></textarea>
                    </div>
                    <div>
                        <button type = "submit">Bình luận</button>
                    </div>
                </form>
            </div>
            <br>
            <div class = "comments-section" th:each = "comment : ${comments}">
                <div class = "comment">
                    <h5 th:text = "${comment.commenter}"></h5>
                    <span th:text = "${comment.content}"></span>
                </div>
            </div>
            <div class = "cboxOverlay" id = "cboxOverlay"></div>
            <div class = "colorbox" id = "colorbox">
                <button class = "cboxClose" id = "cboxClose">Close</button>
                <iframe allow = "autoplay; encrypted-media" allowfullscreen frameborder = "0" height = "360" id = "movieTrailer" loading = "lazy" th:if = "${!movie.trailerUrl.isEmpty()}" th:src = "'https://www.youtube.com/embed/' + ${#strings.substring(movie.trailerUrl, movie.trailerUrl.indexOf('=') + 1)}" width = "640"></iframe>
            </div>
            <script>
                document.getElementById("showTrailerBtn").addEventListener("click", function (e) {
                    if (window.innerWidth < 640) window.open(this.href, "_blank"); else {
                        e.preventDefault(), document.getElementById("cboxOverlay").style.display = "block", document.getElementById("colorbox").style.display = "block";
                        var t = document.getElementById("movieTrailer");
                        t.src = t.src
                    }
                }), document.getElementById("cboxClose").addEventListener("click", function () {
                    document.getElementById("cboxOverlay").style.display = "none", document.getElementById("colorbox").style.display = "none";
                    var e = document.getElementById("movieTrailer");
                    e.src = e.src
                }), document.getElementById("cboxOverlay").addEventListener("click", function () {
                    document.getElementById("cboxOverlay").style.display = "none", document.getElementById("colorbox").style.display = "none";
                    var e = document.getElementById("movieTrailer");
                    e.src = e.src
                })
            </script>
            <script>
                function toggleDescription() {
                    var e = document.getElementById("description"), t = document.getElementById("show-more-btn");
                    "none" === e.style.maxHeight ? (e.style.maxHeight = "9em", t.textContent = "Xem thêm") : (e.style.maxHeight = "none", t.textContent = "Thu gọn")
                }

                document.addEventListener("DOMContentLoaded", function () {
                    var e = document.getElementById("description"), t = document.getElementById("show-more-btn");
                    e.scrollHeight > e.clientHeight && (t.style.display = "block")
                })
            </script>
            <script>
                const modal = document.getElementById("customAlert");

                const errorReport = "[[${errorReport}]]";
                if (errorReport) {
                    modal.style.display = "block";
                }

                window.onclick = function (event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                }
            </script>
        </section>
    </body>
</html>